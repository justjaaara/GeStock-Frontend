<div class="inventory-container">
  <!-- Estad√≠sticas superiores -->
  <div class="grid">
    <app-stat-card title="Total Productos" [value]="stats().totalProducts" icon="üì¶">
    </app-stat-card>

    <app-stat-card
      title="Stock Bajo"
      [value]="stats().lowStockProducts"
      icon="‚ö†Ô∏è"
      variant="warning"
    >
    </app-stat-card>

    <app-stat-card
      title="Productos Inactivos"
      [value]="stats().inactiveProducts"
      icon="üö®"
      variant="danger"
    >
    </app-stat-card>

    <app-stat-card title="Valor Total" [value]="stats().totalValue" icon="üí∞"> </app-stat-card>
  </div>

  <!-- Panel principal -->
  <div class="panel">
    <div class="panel-header">
      <h4>Inventario de Productos</h4>
    </div>

    <!-- Estados de carga y error -->
    @if (isLoading()) {
    <div style="text-align: center; padding: 2rem">
      <div class="loading-spinner" style="margin: 0 auto 1rem"></div>
      <p>Cargando inventario...</p>
    </div>
    } @if (error()) {
    <div style="text-align: center; padding: 2rem">
      <p style="color: #e74c3c; margin-bottom: 1rem">{{ error() ?? 'Error desconocido' }}</p>
      <button (click)="refreshInventory()" class="btn nav">üîÑ Reintentar</button>
    </div>
    }

    <!-- Controles y filtros -->
    @if (!isLoading() && !error()) {
    <div class="controls">
      <div class="field">
        <select #categorySelect (change)="categoryFilter.set(categorySelect.value)">
          <option value="" [selected]="categoryFilter() === ''">Todas las categor√≠as</option>
          @if (categoriesLoading()) {
          <option disabled>Cargando categor√≠as...</option>
          } @else { @for (category of categories(); track category.categoryId) {
          <option
            [value]="category.categoryName"
            [selected]="categoryFilter() === category.categoryName"
          >
            {{ category.categoryName }}
          </option>
          } }
        </select>
      </div>

      <div class="field">
        <select
          #stockLevelSelect
          [value]="stockLevelFilter()"
          (change)="stockLevelFilter.set(stockLevelSelect.value)"
        >
          <option value="">Todos los niveles de stock</option>
          <option value="Cr√≠tico">Cr√≠tico</option>
          <option value="Stock Bajo">Stock Bajo</option>
          <option value="Sin Stock">Sin Stock</option>
        </select>
      </div>

      <div class="field">
        <select #stateSelect [value]="stateFilter()" (change)="stateFilter.set(stateSelect.value)">
          <option value="">Todos los estados</option>
          <option value="Activo">Activo</option>
          <option value="Inactivo">Inactivo</option>
        </select>
      </div>

      <button class="btn nav primary" (click)="applyFilters()">Filtrar</button>

      @if (hasAppliedFilters()) {
      <button class="btn nav" (click)="resetFilters()">Limpiar filtros</button>
      }
    </div>
    <!-- Paginaci√≥n superior -->
    @if (paginationInfo() && paginationInfo()!.totalPages > 1) {
    <div class="pagination-container">
      <div class="page-info">
        Mostrando {{ paginationInfo()!.showingFrom }}-{{ paginationInfo()!.showingTo }} de
        {{ paginationInfo()!.totalItems }} productos
      </div>

      <div class="pagination-buttons">
        <button (click)="prevPage()" [disabled]="!paginationInfo()?.hasPrevious" class="btn nav">
          ‚Üê Anterior
        </button>

        @for (page of getPaginationPages(); track page) {
        <button
          (click)="goToPage(page)"
          [ngClass]="{
            'btn-pagination-active': page === paginationInfo()!.currentPage,
            'btn nav': page !== paginationInfo()!.currentPage
          }"
        >
          {{ page }}
        </button>
        }

        <button (click)="nextPage()" [disabled]="!paginationInfo()?.hasNext" class="btn nav">
          Siguiente ‚Üí
        </button>
      </div>
    </div>
    }

    <!-- Tabla de productos -->
    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Producto</th>
            <th>Categor√≠a</th>
            <th>Stock Actual</th>
            <th>Stock M√≠n.</th>
            <th>Precio Unit.</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (product of products(); track product.code) {
          <tr>
            <td>
              <span class="link-id">{{ product.code }}</span>
            </td>
            <td>
              <div class="cell-product">
                <div class="name">{{ product.name }}</div>
                @if (product.subtitle) {
                <div class="sub">{{ product.subtitle }}</div>
                }
              </div>
            </td>
            <td>{{ product.category }}</td>
            <td class="bold">{{ product.stock }}</td>
            <td>{{ product.min }}</td>
            <td class="bold">{{ product.price | currency : 'COP' : 'symbol' : '1.2-2' }}</td>
            <td>
              <span
                class="pill"
                [ngClass]="{
                  ok: product.status === 'Activo',
                  warn: product.status === 'Stock Bajo',
                  crit: product.status === 'Cr√≠tico' || product.status === 'Sin Stock'
                }"
              >
                {{ product.status }}
              </span>
            </td>
            <td class="actions">
              <button
                class="icon-btn"
                title="Ver detalles"
                (click)="openProductDetailModal(product)"
              >
                üëÅÔ∏è
              </button>
              <button
                class="icon-btn"
                title="Editar producto"
                (click)="openEditProductModal(product)"
              >
                ‚úèÔ∏è
              </button>
              <button
                class="icon-btn icon-btn-danger"
                title="Eliminar producto"
                (click)="openDeleteConfirmModal(product)"
              >
                ‚ùå
              </button>
            </td>
          </tr>
          }
        </tbody>
      </table>

      <!-- Mensaje cuando no hay productos -->
      @if (products().length === 0) {
      <div style="text-align: center; padding: 2rem; color: #6b7a90">
        <p>No se encontraron productos en el inventario.</p>
      </div>
      }
    </div>
    }
  </div>

  <!-- Modal de crear producto -->
  <app-modal
    [isOpen]="showCreateProductModal()"
    title="Crear Nuevo Producto"
    [customContent]="true"
    (cancel)="closeCreateProductModal()"
  >
    <app-product-form
      [categories]="categories()"
      [measurementTypes]="measurementTypes()"
      (submitProduct)="handleCreateProduct($event)"
      (cancel)="closeCreateProductModal()"
    ></app-product-form>
  </app-modal>

  <!-- Modal de detalles del producto -->
  <app-modal
    [isOpen]="showProductDetailModal()"
    [title]="'Detalles del Producto'"
    [customContent]="true"
    (cancel)="closeProductDetailModal()"
  >
    <app-product-detail
      [product]="selectedProductForDetail()"
      (close)="closeProductDetailModal()"
      (edit)="handleEditProduct($event)"
      (updateStock)="handleUpdateStock($event)"
    ></app-product-detail>
  </app-modal>

  <!-- Modal de editar producto -->
  <app-modal
    [isOpen]="showEditProductModal()"
    title="Editar Producto"
    [customContent]="true"
    (cancel)="closeEditProductModal()"
  >
    @if (selectedProductForEdit()) {
    <app-edit-product-form
      [categories]="categories()"
      [product]="selectedProductForEdit()!"
      (updateProduct)="handleUpdateProduct($event)"
      (cancel)="closeEditProductModal()"
    ></app-edit-product-form>
    }
  </app-modal>

  <!-- Modal de confirmaci√≥n de eliminaci√≥n -->
  <app-modal
    [isOpen]="showDeleteConfirmModal()"
    title="Confirmar Eliminaci√≥n"
    [customContent]="true"
    (cancel)="closeDeleteConfirmModal()"
  >
    <div style="padding: 1.5rem">
      @if (selectedProductForDelete()) {
      <div style="text-align: center">
        <div style="font-size: 3rem; margin-bottom: 1rem">‚ö†Ô∏è</div>
        <h3 style="margin-bottom: 1rem; color: #dc3545">¬øEst√°s seguro?</h3>
        <p style="margin-bottom: 1.5rem; color: #6c757d">
          Esta acci√≥n eliminar√° permanentemente el producto:
        </p>
        <div
          style="
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid #dc3545;
          "
        >
          <strong>{{ selectedProductForDelete()!.name }}</strong
          ><br />
          <small style="color: #6c757d">C√≥digo: {{ selectedProductForDelete()!.code }}</small>
        </div>
        <p style="margin-bottom: 2rem; font-weight: 500; color: #dc3545">
          Esta acci√≥n no se puede deshacer.
        </p>

        <div style="display: flex; gap: 1rem; justify-content: center">
          <button class="btn nav" (click)="closeDeleteConfirmModal()" [disabled]="isDeleting()">
            Cancelar
          </button>
          <button
            class="btn danger"
            (click)="confirmDeleteProduct()"
            [disabled]="isDeleting()"
            style="background: #dc3545; color: white; border-color: #dc3545"
          >
            @if (isDeleting()) {
            <span>Eliminando...</span>
            } @else {
            <span>S√≠, eliminar producto</span>
            }
          </button>
        </div>
      </div>
      }
    </div>
  </app-modal>
</div>
